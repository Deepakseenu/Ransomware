<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Honeypot Monitoring Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <style>
    .hidden { display: none; }
    body.dark { background-color: #1a1a1a; color: #e5e5e5; }
    .card { @apply p-4 rounded-2xl shadow-md bg-white dark:bg-gray-800 transition; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div class="flex flex-col h-screen">
    <!-- Top Navbar -->
    <header class="flex items-center justify-between px-6 py-3 bg-blue-700 text-white shadow-lg">
      <h1 class="text-xl font-bold">Honeypot Monitoring Dashboard</h1>
      <div>
        <button id="modeToggle" class="px-3 py-1 bg-blue-900 rounded-lg">🌙 Dark</button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="flex flex-wrap bg-gray-200 dark:bg-gray-800 p-2 justify-around">
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('overview')">Overview</button>
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('events')">Events</button>
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('quarantine')">Quarantine</button>
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('blocked')">Blocked IPs</button>
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('processes')">Processes</button>
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('network')">Network</button>
      <button class="tab-btn px-3 py-2 rounded hover:bg-blue-400" onclick="showTab('map')">Map</button>
    </nav>

    <!-- Content Area -->
    <main class="flex-1 overflow-y-auto p-6 space-y-6">

      <!-- Overview Tab -->
      <section id="overview" class="tab-section">
        <h2 class="text-2xl font-semibold mb-4">System Overview</h2>
        <div id="overview-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="card">CPU: <span id="cpuUsage">--</span>%</div>
          <div class="card">Memory: <span id="memUsage">--</span>%</div>
          <div class="card">Blocked IPs: <span id="blockedCount">--</span></div>
          <div class="card">Recent Events: <span id="eventCount">--</span></div>
        </div>
      </section>

      <!-- Events Tab -->
      <section id="events" class="tab-section hidden">
        <h2 class="text-2xl font-semibold mb-4">Live Events</h2>
        <pre id="eventLog" class="bg-gray-900 text-green-400 p-3 rounded-lg h-96 overflow-y-auto"></pre>
      </section>

      <!-- Quarantine Tab -->
      <section id="quarantine" class="tab-section hidden">
        <h2 class="text-2xl font-semibold mb-4">Quarantined Files</h2>
        <ul id="quarantineList" class="list-disc pl-5"></ul>
      </section>

      <!-- Blocked IPs Tab -->
      <section id="blocked" class="tab-section hidden">
        <h2 class="text-2xl font-semibold mb-4">Blocked IPs</h2>
        <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg">
          <thead><tr><th class="px-4 py-2">IP</th><th class="px-4 py-2">Reason</th><th class="px-4 py-2">Last Blocked</th></tr></thead>
          <tbody id="blockedTable"></tbody>
        </table>
      </section>

      <!-- Processes Tab -->
      <section id="processes" class="tab-section hidden">
        <h2 class="text-2xl font-semibold mb-4">Top Processes</h2>
        <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg">
          <thead><tr><th>PID</th><th>Name</th><th>CPU%</th><th>Memory%</th></tr></thead>
          <tbody id="processTable"></tbody>
        </table>
      </section>

      <!-- Network Tab -->
      <section id="network" class="tab-section hidden">
        <h2 class="text-2xl font-semibold mb-4">Network Stats</h2>
        <p>Bytes Sent: <span id="bytesSent">--</span></p>
        <p>Bytes Received: <span id="bytesRecv">--</span></p>
      </section>

      <!-- Map Tab -->
      <section id="map" class="tab-section hidden h-[500px]">
        <h2 class="text-2xl font-semibold mb-4">Suspicious IP Map</h2>
        <div id="ipMap" style="height:400px;" class="rounded-xl shadow-lg"></div>
      </section>
    </main>
  </div>

<script>
let dark = false;
document.getElementById("modeToggle").addEventListener("click", () => {
  dark = !dark;
  document.body.classList.toggle("dark", dark);
  document.getElementById("modeToggle").textContent = dark ? "☀️ Light" : "🌙 Dark";
});

function showTab(tabId) {
  document.querySelectorAll(".tab-section").forEach(el => el.classList.add("hidden"));
  document.getElementById(tabId).classList.remove("hidden");
}

// Socket.IO for live events
const socket = io();
socket.on("new_event", (data) => {
  const log = document.getElementById("eventLog");
  log.textContent += JSON.stringify(data) + "\\n";
  log.scrollTop = log.scrollHeight;
});

// Auto-refresh overview
async function refreshOverview() {
  const res = await fetch("/api/live_status");
  const d = await res.json();
  document.getElementById("cpuUsage").textContent = d.cpu;
  document.getElementById("memUsage").textContent = d.memory;
  document.getElementById("blockedCount").textContent = d.blocked_ips;
  document.getElementById("eventCount").textContent = d.recent_events;
}
setInterval(refreshOverview, 5000);
refreshOverview();

// Load Blocked IPs + Map
async function loadBlockedIPs() {
  const res = await fetch("/api/blocked_ips");
  const list = await res.json();
  const tbody = document.getElementById("blockedTable");
  tbody.innerHTML = "";
  list.forEach(x => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${x.ip}</td><td>${x.reason || ""}</td><td>${x.last_blocked || ""}</td>`;
    tbody.appendChild(tr);
  });
  updateMap(list);
}

// Leaflet Map
let map = L.map("ipMap").setView([20, 0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

async function updateMap(ips) {
  for (const ip of ips) {
    try {
      const geo = await fetch(`https://ipapi.co/${ip.ip}/json/`);
      const loc = await geo.json();
      if (loc.latitude && loc.longitude) {
        L.marker([loc.latitude, loc.longitude])
          .addTo(map)
          .bindPopup(`<b>${ip.ip}</b><br>${loc.city || ""}, ${loc.country_name || ""}`);
      }
    } catch(e) {}
  }
}

loadBlockedIPs();
showTab("overview");
</script>
</body>
</html>
